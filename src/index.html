<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.10.5/viewer.css"
      integrity="sha512-c7kgo7PyRiLnl7mPdTDaH0dUhJMpij4aXRMOHmXaFCu96jInpKc8sZ2U6lby3+mOpLSSlAndRtH6dIonO9qVEQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/index.css" />
    <title>Test</title>
  </head>
  <body>
    <div id="main_container" class="container-fluid">
      <div class="d-flex flex-row-reverse">
        <div class="col-1"></div>
        <div class="left col-2">
          <div class="row mt-5">
            <div class="col-6">
              <p class="text-white" style="padding: 0; margin: 0">
                Nytt prosjekt:
              </p>
              <input type="text" class="form-control" />
            </div>
            <div class="col-6">
              <p class="text-white" style="padding: 0; margin: 0">
                Velg prosjekt:
              </p>
              <select id="projectFolders" class="form-select mb-3">
                <option class="form-select" value="1" selected>
                  Loading...
                </option>
              </select>
            </div>
          </div>
          <div class="row mt-5">
            <p class="text-white" style="padding: 0; margin: 0">Prefix:</p>
            <input type="text" id="prefix" class="form-control" />
            <p class="subtitle text-white" style="padding: 0; margin: 0">
              "prefix"_14-8-2022_1.jpg
            </p>
          </div>
          <div class="row mt-5">
            <button id="capture_image" class="btn btn-main">
              Take picture
            </button>
          </div>
          <div class="row mt-5">
            <button id="download" class="btn btn-main">Download</button>
          </div>
        </div>
        <div class="col-1"></div>
        <div class="right col-8 shadow">
          <div id="image_container">
            <img id="image" src="/icons/video-slash.png" alt="" hidden />
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.10.5/viewer.min.js"
      integrity="sha512-i5q29evO2Z4FHGCO+d5VLrwgre/l+vaud5qsVqQbPXvHmD9obORDrPIGFpP2+ep+HY+z41kAmVFRHqQAjSROmA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.6.1.min.js"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
      crossorigin="anonymous"
    ></script>
    <script type="text/javascript">
      axios
        .get("/storage")
        .then((response) => {
          var data;
          response.data.map((item) => {
            data += `<option class="form-select" value="${item}">${item}</option>`;
          });
          $("#projectFolders").html(data);
        })
        .catch((error) => {
          console.log(error);
        });
        $("#prefix").val() === "" ? $("#capture_image").attr("disabled", true) : $("#capture_image").attr("disabled", false);
        $("#prefix").on("input", () => {
          $("#prefix").val() === "" ? $("#capture_image").attr("disabled", true) : $("#capture_image").attr("disabled", false);
        });
    </script>
    <script type="text/javascript">
      const request = async (req, prefix) => {
        return await axios
          .get(`/camera/${req}/${prefix}`)
          .then((response) => {
            return response;
          })
          .catch((error) => {
            console.log(error);
          });
      };
      $("#capture_image").click(async () => {
        const response = await request("capture", $("#prefix").val());
        console.log(response);
        $("#image_container").html(response.data.img);
        const viewer = new Viewer(document.getElementById("image"), {
          inline: true,
          backdrop: false,
          focus: true,
          fullscreen: true,
          loading: true,
          keyboard: true,
          movable: true,
          navbar: false,
          rotatable: true,
          scalabe: true,
          slideOnTouch: true,
          title: true,
          toggleOnDblclick: true,
          toolbar: true,
          tooltop: true,
          transition: true,
          zoomable: true,
          zoomOnTouch: true,
          zoomOnWheel: true,
          viewed() {
            viewer.zoomTo(0.2);
          },
        });
      });
      $("#download").click(async () => {
        window.open(`/camera/download`);
      });
      const viewer = new Viewer(document.getElementById("image"), {
        inline: true,
        backdrop: false,
        focus: true,
        fullscreen: true,
        loading: true,
        keyboard: true,
        movable: true,
        navbar: false,
        rotatable: false,
        scalabe: false,
        slideOnTouch: true,
        title: true,
        toggleOnDblclick: true,
        toolbar: false,
        tooltop: true,
        transition: true,
        zoomable: true,
        zoomOnTouch: true,
        zoomOnWheel: true,
        viewed() {
          viewer.zoomTo(0.2);
        },
      });
    </script>
    <script src="/test/test.ts" type="typescript"></script>
    <script type="module">
      import * as dat from "/scripts/dat.gui.module.js";
      //object containing all GUI elements
      var foo = {};
      //object containing all GUI labels property names
      var settings_name = {};
      //generate camera settings gui
      var camera_settings = async () => {
        //fetch camera settings from settings route
        var settings = await axios.get("/camera/settings").then((response) => {
          return response.data.main.children;
        });
        //loop over settings for parent labels
        for (var i in settings) {
          var parent = settings[i];
          if (settings[i].type === "section") {
            //create gui folder
            var parent = gui.addFolder(parent.label);
          }
          //loop over children of parent labels and values
          for (var x in settings[i].children) {
            var child = settings[i].children[x];
            //create gui element in parent folder with child and value
            if (child.type === "string" || child.type === "date") {
              foo[child.label] = child.value;
              settings_name[child.label] = x;
              parent.add(foo, child.label).onFinishChange(function () {
                //change setting of camera on change in gui
                change_setting(
                  this,
                  settings_name[this.property],
                  foo[this.property]
                );
              });
            } else if (child.type === "toggle") {
              foo[child.label] = child.value;
              settings_name[child.label] = x;
              parent.add(foo, child.label, 0, 1, 1).onFinishChange(function () {
                change_setting(
                  this,
                  settings_name[this.property],
                  foo[this.property]
                );
              });
            } else if (child.type === "choice") {
              foo[child.label] = child.value;
              settings_name[child.label] = x;
              parent
                .add(foo, child.label, child.choices)
                .onFinishChange(function () {
                  change_setting(
                    this,
                    settings_name[this.property],
                    foo[this.property]
                  );
                });
            }
          }
        }
      };
      var change_setting = (t, name, value) => {
        if (t.isModified()) {
          t.initialValue = foo[t.property];
          gui.domElement.style.pointerEvents = "none";
          gui.domElement.style.opacity = 0.8;
          axios
            .put(`/camera/settings/${name}`, { newValue: value })
            .then((response) => {
              console.log(response);
              gui.domElement.style.pointerEvents = "";
              gui.domElement.style.opacity = 1;
            })
            .catch((err) => {
              if (err) {
                console.log(err);
                gui.domElement.style.pointerEvents = "";
                gui.domElement.style.opacity = 1;
              }
            });
        }
      };

      var gui = new dat.GUI({
        closed: true,
        closeOnTop: true,
      });
      await camera_settings();
    </script>
  </body>
</html>
