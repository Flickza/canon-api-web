<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.10.5/viewer.css"
      integrity="sha512-c7kgo7PyRiLnl7mPdTDaH0dUhJMpij4aXRMOHmXaFCu96jInpKc8sZ2U6lby3+mOpLSSlAndRtH6dIonO9qVEQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="/css/index.css" />
    <title>Test</title>
  </head>
  <body>
    <div id="main_container" class="container-fluid">
      <div class="d-flex flex-row-reverse">
        <div class="col-1"></div>
        <div class="left col-2">
          <div class="row mt-5">
            <button id="test" class="btn btn-main">
              Set working directory
            </button>
          </div>
          <div class="row mt-5">
            <button id="capture_image" class="btn btn-main">
              Take picture
            </button>
          </div>
          <div class="row mt-5">
            <button id="download" class="btn btn-main">Download</button>
          </div>
        </div>
        <div class="col-1"></div>
        <div class="right col-8 shadow">
          <div id="image_container">
            <img id="image" src="/icons/video-slash.png" alt="" hidden />
          </div>
        </div>
      </div>
    </div>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.10.5/viewer.min.js"
      integrity="sha512-i5q29evO2Z4FHGCO+d5VLrwgre/l+vaud5qsVqQbPXvHmD9obORDrPIGFpP2+ep+HY+z41kAmVFRHqQAjSROmA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.6.1.min.js"
      integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
      crossorigin="anonymous"
    ></script>
    <script type="text/javascript">
      const request = async (req) => {
        return await axios
          .get(`/camera/${req}`)
          .then((response) => {
            return response;
          })
          .catch((error) => {
            console.log(error);
          });
      };
      $("#capture_image").click(async () => {
        const response = await request("capture");
        console.log(response);
        $("#image_container").html(response.data.img);
        const viewer = new Viewer(document.getElementById("image"), {
          inline: true,
          backdrop: false,
          focus: true,
          fullscreen: true,
          loading: true,
          keyboard: true,
          movable: true,
          navbar: false,
          rotatable: true,
          scalabe: true,
          slideOnTouch: true,
          title: true,
          toggleOnDblclick: true,
          toolbar: true,
          tooltop: true,
          transition: true,
          zoomable: true,
          zoomOnTouch: true,
          zoomOnWheel: true,
          viewed() {
            viewer.zoomTo(0.2);
          },
        });
      });
      $("#download").click(async () => {
        window.open(`/camera/download`);
      });
      const viewer = new Viewer(document.getElementById("image"), {
        inline: true,
        backdrop: false,
        focus: true,
        fullscreen: true,
        loading: true,
        keyboard: true,
        movable: true,
        navbar: false,
        rotatable: false,
        scalabe: false,
        slideOnTouch: true,
        title: true,
        toggleOnDblclick: true,
        toolbar: false,
        tooltop: true,
        transition: true,
        zoomable: true,
        zoomOnTouch: true,
        zoomOnWheel: true,
        viewed() {
          viewer.zoomTo(0.2);
        },
      });
    </script>
    <p id="data"></p>
    <script type="module">
      import * as dat from "/scripts/dat.gui.module.js";
      var foo = {};
      var settings_name = {};
      var camera_settings = async () => {
        var settings = await axios.get("/camera/settings").then((response) => {
          return response.data.main.children;
        });
        for (var i in settings) {
          var parent = settings[i];
          if (settings[i].type === "section") {
            var parent = gui.addFolder(parent.label);
          }
          for (var x in settings[i].children) {
            var child = settings[i].children[x];
            if (child.type === "string" || child.type === "date") {
              foo[child.label] = child.value;
              settings_name[child.label] = x;
              parent.add(foo, child.label).onFinishChange(function () {
                if (this.isModified()) {
                  console.log("Modified", this.property);
                  change_setting(
                    settings_name[this.property],
                    foo[this.property]
                  );
                }
              });
            } else if (child.type === "toggle") {
              foo[child.label] = child.value;
              settings_name[child.label] = x;
              parent.add(foo, child.label, 0, 1, 1).onFinishChange(function () {
                if (this.isModified()) {
                  console.log("Modified", this.property);
                  change_setting(
                    settings_name[this.property],
                    foo[this.property]
                  );
                }
              });
            } else if (child.type === "choice") {
              foo[child.label] = child.value;
              settings_name[child.label] = x;
              parent
                .add(foo, child.label, child.choices)
                .onFinishChange(function () {
                  if (this.isModified()) {
                    console.log("Modified", this.property);
                    change_setting(
                      settings_name[this.property],
                      foo[this.property]
                    );
                  }
                });
            }
          }
        }
      };
      var change_setting = (name, value) => {
        console.log(name, value);
        gui.domElement.style.pointerEvents = "none";
        gui.domElement.style.opacity = 0.8;
        axios
          .put(`/camera/settings/${name}`, { newValue: value })
          .then((response) => {
            console.log(response);
            gui.domElement.style.pointerEvents = "";
            gui.domElement.style.opacity = 1;
          });
      };

      var gui = new dat.GUI();
      await camera_settings();
      console.log(gui);
    </script>
  </body>
</html>
